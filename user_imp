#!/usr/local/bin/php
<?php

// $Id: user_imp,v 1.2 2006/02/25 17:58:04 tessus Exp $

if( $argc != 2 )
{
   echo "\nUsage: user_imp USER-FILE\n";
   echo "\n   USER-FILE		user file generated by htpasswd\n\n";
   
   exit(1);
}

if( !file_exists( $argv[1] ) )
{
   echo "\n$argv[1] does not exist!\n\n";
   
   exit(1);
}

if( !is_readable( $argv[1] ) )
{
   echo "\n$argv[1] is not readable!\n\n";
   
   exit(1);
}
   
putenv ("DB2DIR=/opt/IBM/db2/V8.1");
putenv ("DB2INSTANCE=db2inst1");
putenv ("LD_LIBRARY_PATH=:/home/db2inst1/sqllib/lib");
putenv ("LIBPATH=:/home/db2inst1/sqllib/lib");

require ('./config.php');

$handle = fopen ($argv[1], "r");

while (!feof ($handle)) 
{
    $line = fgets($handle, 512);
    
    list($username,$password) = explode(":",$line);
    
    if( $username != '' )
    {
       if( substr( $password, -1 ) == "\n" )
          $password = substr($password,0,-1);
       $arr["$username"] = $password;
    }
}
    
fclose ($handle);

$conn = db2_connect( $dbname, $dbuser, $dbpwd );

echo "\nImporting users into table '$usertable' in database '$dbname'\n\n";

$i = 0;
$ni = 0;

foreach ($arr as $u => $p)
{
   $insert = "insert into $usertable ($namefield, $passwordfield) values ('$u', '$p')";
   $res=@db2_exec( $conn, $insert );
   
   if( $res != FALSE )
   {
      echo "User $u imported.\n";
      $i++;
   }
   else
   {
      echo "User $u NOT imported.\n";
      $ni++;
   }
}

echo "\n";
echo "Users imported: $i\n";
echo "Users rejected: $ni\n";
echo "\n";

return 0;

?>
